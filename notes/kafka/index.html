<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Arun S">
        <link rel="canonical" href="https://notes.arunsr.in/notes/kafka/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>🐞 Kafka - arunsrin's notes</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/solarized-dark.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="../..">arunsrin's notes</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">🏡 Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../../about/" class="nav-link">🐧About</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Books <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../books/" class="dropdown-item">📖Books</a>
</li>
                                    
<li>
    <a href="../../books/2019/" class="dropdown-item">📚 2019</a>
</li>
                                    
<li>
    <a href="../../books/2020/" class="dropdown-item">📚 2020</a>
</li>
                                    
<li>
    <a href="../../books/2021/" class="dropdown-item">📚 2021</a>
</li>
                                    
<li>
    <a href="../../books/2022/" class="dropdown-item">📚 2022</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Intro</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../books/intro/" class="dropdown-item">📃 Oxford - A Very Short Introduction Series</a>
</li>
            
<li>
    <a href="../../books/intro/accounting/" class="dropdown-item">📃 Accounting</a>
</li>
            
<li>
    <a href="../../books/intro/advertising/" class="dropdown-item">📃 Advertising</a>
</li>
            
<li>
    <a href="../../books/intro/alexander/" class="dropdown-item">📃 Alexander the Great</a>
</li>
            
<li>
    <a href="../../books/intro/anaesthesia/" class="dropdown-item">📃 Anaesthesia</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Reviews</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../books/reviews/crypto101/" class="dropdown-item">📝 Crypto 101</a>
</li>
            
<li>
    <a href="../../books/reviews/despair/" class="dropdown-item">📝 Despair, by Vladimir Nabokov</a>
</li>
            
<li>
    <a href="../../books/reviews/eats-shoots-leaves/" class="dropdown-item">📝 Eats, Shoots & Leaves</a>
</li>
            
<li>
    <a href="../../books/reviews/flow/" class="dropdown-item">📝 Flow</a>
</li>
            
<li>
    <a href="../../books/reviews/good-math/" class="dropdown-item">📝 Good Math</a>
</li>
            
<li>
    <a href="../../books/reviews/happiness/" class="dropdown-item">📝 The Happiness Hypothesis</a>
</li>
            
<li>
    <a href="../../books/reviews/hate-inc/" class="dropdown-item">📝 Hate Inc.</a>
</li>
            
<li>
    <a href="../../books/reviews/how-to-read-a-book/" class="dropdown-item">📝 How To Read A Book</a>
</li>
            
<li>
    <a href="../../books/reviews/the-art-of-the-infinite/" class="dropdown-item">📝 The Art of the Infinite</a>
</li>
            
<li>
    <a href="../../books/reviews/thinking-climate-change/" class="dropdown-item">📝 The Thinking Person's Guide to Climate Change</a>
</li>
            
<li>
    <a href="../../books/reviews/we-are-our-brains/" class="dropdown-item">📝 We Are Our Brains</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Games <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../games/" class="dropdown-item">🎮Games</a>
</li>
                                    
<li>
    <a href="../../games/2019-and-before/" class="dropdown-item">🎮 2019 and before</a>
</li>
                                    
<li>
    <a href="../../games/2020/" class="dropdown-item">🎮 2020</a>
</li>
                                    
<li>
    <a href="../../games/2021/" class="dropdown-item">🎮 2021</a>
</li>
                                    
<li>
    <a href="../../games/2022/" class="dropdown-item">🎮 2022</a>
</li>
                                    
<li>
    <a href="../../games/xboxone/" class="dropdown-item">🎮Xbox One</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Heroes <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../heroes/chomsky/" class="dropdown-item">💭 Noam Chomsky</a>
</li>
                                    
<li>
    <a href="../../heroes/dawkins/" class="dropdown-item">🧬 Richard Dawkins</a>
</li>
                                    
<li>
    <a href="../../heroes/sagan/" class="dropdown-item">🌌 Carl Sagan</a>
</li>
                                    
<li>
    <a href="../../heroes/stallman/" class="dropdown-item">🐧 Richard Stallman</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Notes <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../ansible/" class="dropdown-item">🅰️ Ansible</a>
</li>
                                    
<li>
    <a href="../aws/" class="dropdown-item">☁️ AWS</a>
</li>
                                    
<li>
    <a href="../browsers/" class="dropdown-item">🌐 Browsers</a>
</li>
                                    
<li>
    <a href="../databases/" class="dropdown-item">💾 Databases</a>
</li>
                                    
<li>
    <a href="../docker/" class="dropdown-item">🐋 Docker</a>
</li>
                                    
<li>
    <a href="../editors/" class="dropdown-item">⌨️ Editors</a>
</li>
                                    
<li>
    <a href="../elastic/" class="dropdown-item">🔍 Elastic Stack</a>
</li>
                                    
<li>
    <a href="../git/" class="dropdown-item">💾 Git</a>
</li>
                                    
<li>
    <a href="../grafana/" class="dropdown-item">📈 Grafana</a>
</li>
                                    
<li>
    <a href="../k8s/" class="dropdown-item">☸️ Kubernetes</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">🐞 Kafka</a>
</li>
                                    
<li>
    <a href="../networking/" class="dropdown-item">🕸️ Networking</a>
</li>
                                    
<li>
    <a href="../openssl/" class="dropdown-item">🔒 OpenSSL</a>
</li>
                                    
<li>
    <a href="../security/" class="dropdown-item">🔒 Security</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Linux</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../linux/" class="dropdown-item">🐧Linux</a>
</li>
            
<li>
    <a href="../linux/learnings-and-notes/" class="dropdown-item">🐧 Learnings/Notes</a>
</li>
            
<li>
    <a href="../linux/package-management/" class="dropdown-item">🐧 Package management</a>
</li>
            
<li>
    <a href="../linux/systemd/" class="dropdown-item">🐧Systemd</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Programming</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../programming/" class="dropdown-item">💻Programming</a>
</li>
            
<li>
    <a href="../programming/go/" class="dropdown-item">🐹 Go</a>
</li>
            
<li>
    <a href="../programming/java/" class="dropdown-item">🍵 Java</a>
</li>
            
<li>
    <a href="../programming/python/" class="dropdown-item">🐍Python notes</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Research <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../research/capitalism/" class="dropdown-item">💰 Capitalism</a>
</li>
                                    
<li>
    <a href="../../research/climate-change/" class="dropdown-item">🌡️ Climate Change</a>
</li>
                                    
<li>
    <a href="../../research/covid-19/" class="dropdown-item">🦠 COVID-19 References</a>
</li>
                                    
<li>
    <a href="../../research/cryptocurrencies/" class="dropdown-item">💸 Cryptocurrencies</a>
</li>
                                    
<li>
    <a href="../../research/philosophy/" class="dropdown-item">💭 Philosophy / Morality</a>
</li>
                                    
<li>
    <a href="../../research/privacy-internet/" class="dropdown-item">🔏 Online Privacy and the Internet</a>
</li>
                                    
<li>
    <a href="../../research/productivity/" class="dropdown-item">✅ Productivity</a>
</li>
                                    
<li>
    <a href="../../research/scepticism/" class="dropdown-item">💭 Scepticism</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../k8s/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../networking/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/arunsrin/arunsrin.mkdocs/blob/master/home/notes/kafka.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#kafka" class="nav-link">🐞 Kafka</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#the-basics" class="nav-link">The Basics</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#topics" class="nav-link">Topics</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#partitions-storage" class="nav-link">Partitions (Storage)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#streams-and-tables" class="nav-link">Streams and Tables</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#fault-tolerance" class="nav-link">Fault tolerance</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#elasticity" class="nav-link">Elasticity</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="kafka">🐞 Kafka</h1>
<p>These notes are based on a series of posts I read, starting with <a href="https://www.confluent.io/blog/kafka-streams-tables-part-1-event-streaming/">this
one</a>.</p>
<h2 id="the-basics">The Basics</h2>
<p>Basically it lets you pub/sub to Events.</p>
<p>And store them.</p>
<p>And process and analyze them.</p>
<hr />
<p>An <strong>Event</strong> is something that has a key, value and timestamp.</p>
<p>And a <strong>Table</strong> represents the state at that particular point in time. This is
mutable. </p>
<p>A <strong>Stream</strong> provides immutable data. You can insert stuff into it. </p>
<p>You can convert a stream to a table by aggregating it with operations like
<code>COUNT()</code> or <code>SUM()</code>.</p>
<p>And you convert a table to a stream by capturing the mutations made to it into
a change stream. Also called <strong>CDC</strong> (Change Data Capture). I guess it’s a
stream that replays all the add/edit/remove actions done on that table.</p>
<h2 id="topics">Topics</h2>
<p>Kafka's storage layer. Events are persisted here.</p>
<p><strong>Brokers</strong> are machines that store and serve the data (among other things).</p>
<p>So, a <strong>Topic</strong> is an unbounded sequence of serialized events. You can
configure things for each topic like the storage limit.</p>
<p>Events are serialized when written to a topic and deserialized when read.
Common formats: Avro, protobuf, JSON.</p>
<h2 id="partitions-storage">Partitions (Storage)</h2>
<p>Kafka makes heavy use of <strong>partitions</strong> i.e. a topic is spread over a number of
buckets located on different brokers. While creating a topic you choose the
number of partitions it should contain.</p>
<p>Each of these partitions can then be replicated across regions etc.</p>
<p>Partitions are what enable scalability, fault tolerance, replication etc.</p>
<p><em>Producers determine the event partitioning.</em> They are decoupled from Consumers
completely. The producers use a partitioning function to determine which bucket
to drop the events into. Usually a hash modulo number-of-partitions, so that
there's an even spread.</p>
<p>If somebody adds more partitions to an existing topic, or if a different client
uses a different partitioning function, data that was earlier expected to go to
P1 may now go to Px.</p>
<h2 id="streams-and-tables">Streams and Tables</h2>
<p>Topics are in the storage layer. Whereas Streams / Tables are in processing
layer.</p>
<p>An <strong>Event Stream</strong> is a topic with a schema, i.e. not an opaque byte stream.
You can create a stream by specifying the structure of the events and pointing
to a topic. e.g. here is a stream that's expecting a <code>username</code> and <code>location</code>
key:</p>
<pre class="codehilite"><code>-- Create ksqlDB stream from Kafka topic.   
    CREATE STREAM myStream (username VARCHAR, location VARCHAR)
    WITH (KAFKA_TOPIC='input-topic', VALUE_FORMAT='...');
</code></pre>

<p>From <a href="https://www.confluent.io/blog/kafka-streams-tables-part-3-event-processing-fundamentals/">here</a>.</p>
<hr />
<p>A <strong>table</strong> is a like a SQL table. Also think of it as an aggregated stream.
Tables are usually bounded i.e. fixed set of rows (e.g. product listing). But
can be unbounded as well (e.g. list of new orders)</p>
<p>But usually the producer uses a schema. Here we have a consumer who must have
some kind of contract with the producer to follow the same schema.</p>
<p>Using Avro seems to be a recommended approach. I believe the schema is embedded
in the message.</p>
<hr />
<p>Processing seems to be done per partition which is why it scales well. The
processing application is put in a Kafka consumer group so that they can
coordinate.</p>
<p>The group detects instances joining or leaving the group so that the workload
can be redistributed. This is called <strong>rebalancing</strong>.</p>
<p>A <strong>stream task</strong> is a unit of work that an application works on.</p>
<p>A table is used when you have a stateful application that works on aggregated
data. Kafka uses a <strong>state store</strong> that's persisted on disk so that large
workloads can be processed. Tables and States are also per-partition.</p>
<p>So, based on your workload you will decide your partitioning. e.g. 12GB dataset
could be spread to 4  partitions, where 4 streams would add the schema to the
data, and 4 tasks would allocate 4 applications to store 4 buckets of state and
process it.</p>
<p>Finally you have <strong>global tables</strong> which are not partitioned. e.g. if some kind
of global state was needed. </p>
<h2 id="fault-tolerance">Fault tolerance</h2>
<p>Streams are strongly fault tolerant. If your app crashes, just start back up
and read the topic again.</p>
<p>Tables are persisted to local disk for fault tolerance. If something fails
midway, the app can pick up from where it stopped. The change stream is durably
stored in a topic. So a table can be restored and processing can resume,
without data loss.</p>
<h2 id="elasticity">Elasticity</h2>
<p>Similar to fault tolerance. If more instances are added to a Kafka streams
application, some tasks will be migrated to the new ones.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
